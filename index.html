<html>
<head>
<meta name="viewport" content="width=320" >
<title>@rposbo : UNOFFICIAL Mobile TFL Bus Countdown Board</title>
<style>
body {font-family:calibri,verdana,tahoma,farah; font-size:12px; width:auto; max-width:100%;}
#disclaimer {font-size:8px;}
#disclaimer img {float:left;}
#busListing {display:block;}
a:visited {color:blue;}
#stopListing a {display:block; padding: 5px;margin: .4em 0;background-color:#ecffec; text-decoration:none; color:black;}
#stopListing a:hover {background-color:#ececff;}
#stopListing a:active {background-color:#ffecec;}
.time {margin-right:1em; text-align:right;}
.clock {float:right;}
</style>
<script language="javascript" type="text/javascript">
function ready(fn) {
  if (document.readyState != 'loading'){
    fn();
  } else if (document.addEventListener) {
    document.addEventListener('DOMContentLoaded', fn);
  } else {
    document.attachEvent('onreadystatechange', function() {
      if (document.readyState != 'loading')
        fn();
    });
  }
}

function get(url, fn){
	var request = new XMLHttpRequest();
	request.open('GET', url, true);

	request.onreadystatechange = function() {
	if (this.readyState === 4) {
			if (this.status >= 200 && this.status < 400) {
				var data = JSON.parse(this.responseText);
				fn(data);
			} else {
				console.log('get failed');
			}
		}
	};

	request.send();
	request = null;
}

function forEach(array, fn) {
  for (var i = 0; i < array.length; i++)
    fn(i, array[i]);
}

ready(function() {
	// get lat long
	if (navigator.geolocation){
		navigator.geolocation.getCurrentPosition(function (position) {
			getStopListingForLocation(position.coords.latitude,position.coords.longitude);
		});
	} else {
		alert('could not get your location');
	}
});

const borrowedIds = 'app_id=8268063a&app_key=14f7f5ff5d64df2e88701cef2049c804';
const apiRoot = 'https://api-tigris.tfl.gov.uk';

function getStopListingForLocation(lat, lng){
	var swLat, swLng, neLat, neLng;
	swLat = lat - 0.01;
	swLng = lng - 0.01;
	neLat = lat + 0.01;
	neLng = lng + 0.01;

	var extragumf = '&stopTypes=NaptanPublicBusCoachTram&modes=bus&' + borrowedIds;
	var endpoint = apiRoot + '/StopPoint?swLat=' + swLat + '&swLon=' + swLng + '&neLat=' + neLat + '&neLon=' + neLng + extragumf;

	get(endpoint, function(data) { 
        displayStopListing(data); 
    });
}

function displayStopListing(data){

	var wrapper = document.getElementById("stopListing");

	data.sort(function(a,b) {return (a.commonName > b.commonName) ? 1 : ((b.commonName > a.commonName) ? -1 : 0);} );

	forEach(data, function(i,item) {
		var destination = "";
		if (item.additionalProperties.length > 0)
			for(var i=0; i<item.additionalProperties.length; i++)
			{
				if (item.additionalProperties[i].key == "Towards")
					destination = 'to '+ item.additionalProperties[i].value;
			}

		var a = document.createElement('a');
		a.innerText = item.commonName + ' (stop ' + item.stopLetter + ') ' + destination;
		a.setAttribute("onclick", "getBusListingForStop('" + item.id + "')");
		a.setAttribute("class", "stopListing");
		a.setAttribute("id", item.id);
		a.setAttribute("name","stop_" + item.id);
		wrapper.appendChild(a);
    });
}

function getBusListingForStop(stopId){
    var endpoint =  apiRoot + '/StopPoint/' + stopId + '/Arrivals?' + borrowedIds;
	get(endpoint, function(data) { 
        displayBusListing(data, stopId); 
    });
}

function displayBusListing(data, stopId){

	data.sort(function(a,b) {return (a.timeToStation > b.timeToStation) ? 1 : ((b.timeToStation > a.timeToStation) ? -1 : 0);} );

	var stopEl = document.getElementById(stopId);
	if (stopEl.querySelector("span")) {stopEl.removeChild(stopEl.querySelector("span"));}

	var wrapper = document.createElement('span');
	var h2 = document.createElement('h2');
    h2.innerText = "Buses Due";
	wrapper.appendChild(h2);

	forEach(data, function(i,item){
		var cdText = document.createElement('span');
		cdText.innerText  = countdownText(item.timeToStation);
		cdText.setAttribute("class", "time");
		wrapper.appendChild(cdText);

		var dest = document.createElement('span');
		dest.innerText  = item.lineName + ' to ' + item.destinationName;
		dest.setAttribute("class", "info");
		wrapper.appendChild(dest);

		var clock = document.createElement('span');
		clock.innerText  = expectedArrivalTimeText(item.expectedArrival);
		clock.setAttribute("class", "clock");
		wrapper.appendChild(clock);
		
		wrapper.appendChild(document.createElement('br'));
    });
	stopEl.appendChild(wrapper);
}

function countdownText(seconds){
	var mins = seconds/60;
	return mins > 1 ? Math.floor(mins) + ' min' : 'due';
}

function expectedArrivalTimeText(expectedArrivalTime) {
	if (expectedArrivalTime == null) {return "";}

	var d = new Date(expectedArrivalTime);
	var h = d.getHours() < 10 ? "0" + d.getHours() : d.getHours();
	var m = d.getMinutes() < 10 ? "0" + d.getMinutes() : d.getMinutes();
	return h + ":" + m;
}

</script>
</head>
<body>
<div id="busListing"></div>
<h1>Bus Stops Near You
</h1>
<div id="stopListing"></div>
<hr />
<script async>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55736935-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
